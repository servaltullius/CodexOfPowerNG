# Codex of Power NG v1.0.7 (2026-02-20)

## 요약
세이브 로드 안정성과 설정 반영 우선순위를 보강한 안정화 정식 릴리즈입니다.
로드 실패 시 부분 반영으로 상태가 꼬이는 문제를 막고, 입력 스케일은 모드 설정 파일 값을 항상 우선 적용하도록 정리했습니다.

## 주요 변경점
- Serialization Load를 원자적(atomic) 방식으로 전환
- Undo 이력 로드 시 `formId/regKey` 둘 중 하나라도 해석 실패하면 해당 엔트리 스킵
- UI `uiInputScale` 반영 우선순위를 설정 파일 우선으로 고정
- 등록/Undo 후 인벤토리 페이지가 1페이지로 튀는 동작 수정(마지막 요청 페이지 유지)

## RC 버전별 상세 변경 이력 (`v1.0.7-rc.1` ~ `v1.0.7-rc.19`)
- `rc.1`: 로드 후 `rewardTotals`와 실제 Actor Value를 비교해 누락분만 복원하는 post-load 보정 경로를 도입했습니다.
- `rc.2`: `current/base`, `permanent/base`, modifier 관측치를 합쳐 결손 델타를 계산하고, 로드 직후 다중 패스로 동기화하도록 확장했습니다.
- `rc.3`: 일시 변동 구간 과보정을 줄이기 위해 연속 결손(3회) 조건을 추가하고, 스케줄러 정체를 복구하는 watchdog을 넣었습니다.
- `rc.4`: 설정 레이어를 `settings.json`(기본값) + `settings.user.json`(사용자 오버라이드)로 분리해 재설치/업데이트 시 사용자 설정 보존성을 높였습니다.
- `rc.5`: `SpeedMult` 캡 단위를 `0.50`으로 바로잡고, 로드 시 캡 정규화를 하향-only 정책으로 변경해 과보정 리스크를 낮췄습니다.
- `rc.6`: 보상 직후 전역 full sync를 제거하고 CarryWeight 전용 quick resync(중복 예약 방지, 200ms 간격)를 도입해 반영 안정성과 비용을 함께 개선했습니다.
- `rc.7`: 저장 로드 시 누적 보상 total을 즉시 캡 범위로 정규화하고, CarryWeight 델타를 current 기반으로 계산해 미반영 케이스를 줄였습니다.
- `rc.8`: quick resync rerun 플래그를 추가해 연속 보상 상황에서 요청 유실을 줄이고, carry 델타를 current/snapshot 혼합 신호로 계산하도록 보강했습니다.
- `rc.9`: 구버전 저장 누락 대응용 `Recover Carry +5` 1회 수동 복구 기능(UI/직렬화 포함)을 임시 도입했습니다.
- `rc.10`: `Recover Carry +5` 기능을 제거하고 관련 요청/직렬화 상태를 정리해 런타임 경로를 단순화했습니다.
- `rc.11`: 보상 기본 주기 `rewardEvery`를 `10`에서 `5`로 낮춰 신규/초기 설정에서 보상 체감 빈도를 높였습니다.
- `rc.12`: 치명타/저항 과상한을 줄이기 위한 cap-guard를 보강하고, `rewardMultiplier=0` 저장 왜곡을 수정했으며, WSL 릴리즈 빌드 경로 신뢰성도 개선했습니다.
- `rc.13`: 로드 직후 CarryWeight 보정 누락을 줄이기 위해 non-trivial delta 즉시 적용 + post-load quick resync 추가 예약을 도입했습니다.
- `rc.14`: 비정상 데미지 폭증 방지를 위해 `AttackDamageMult` 보상 총량 상한(+100%)과 비수렴 반복 적용 차단 가드를 넣었습니다.
- `rc.15`: 로드/새게임 경계 타이밍 꼬임을 줄이기 위해 동기화 작업에 epoch 취소 가드와 timeout 기반 readiness 재시도 정책을 적용했습니다.
- `rc.16`: full sync 완료 후 `UpdateWeaponAbility`를 강제 호출해 무기 재장착 전후 공격력 표시/계산 불일치가 남지 않도록 보강했습니다.
- `rc.17`: 무기 보상에서 `% 공격력(AttackDamageMult)` 채널을 제거하고 고정 스킬 보상으로 대체했으며, 기존 세이브 누적분 1회 정리 마이그레이션을 추가했습니다.
- `rc.18`: Undo 탭(최근 10개, 최신 1개 되돌리기)과 Undo 직렬화(`UNDO`)를 추가하고, 롤백량을 실제 클램프 반영량 기준으로 계산하도록 수정했습니다.
- `rc.19`: Serialization Load를 원자적으로 재작성하고, Undo 항목 해석 실패 엔트리를 스킵하며, `uiInputScale`는 모드 설정값 우선으로 고정했습니다.

## 사용자 영향
- 손상/불완전 레코드가 있을 때 부분 상태 반영으로 인한 꼬임 가능성이 줄어듭니다.
- 입력 스케일은 저장된 모드 설정값대로 일관되게 반영됩니다.
- 등록/되돌리기 후에도 Quick Register 페이지/페이지 사이즈가 유지됩니다.

## 기술 변경 상세
- `src/SerializationLoad.cpp`
  - 임시 로드 버퍼(`loaded*`)에 파싱 후 마지막에 상태 커밋
  - Undo 로드 시 `ResolveFormID` 완전 성공 엔트리만 채택
- `src/PrismaUIRequestOps.cpp`
  - 마지막 인벤토리 요청(page/pageSize) 스냅샷 보관
  - register/undo 완료 후 `SnapshotLastInventoryRequest()`로 재요청
- `PrismaUI/views/codexofpowerng/index.html`
  - `uiInputScale`를 settings payload에서 항상 적용
  - localStorage 플래그가 settings 반영을 막지 않도록 조정
- 테스트
  - `tests/serialization_load_atomicity.test.cjs` 추가
  - `tests/undo_registration_flow.test.cjs` 보강
  - `tests/settings_payload_validation.test.cjs` 보강

## 검증
- `node --test tests/undo_registration_flow.test.cjs tests/settings_payload_validation.test.cjs tests/serialization_load_atomicity.test.cjs` : PASS
- `node --test tests/*.cjs` : PASS (72/72)
- `cmake --build --preset wsl-release` : PASS

## 호환성/주의사항
- 본 프로젝트는 구 버전 Codex of Power/SVCollection 세이브 마이그레이션을 목표로 하지 않습니다.
- Undo 엔트리는 안전성 우선 정책으로 해석 불가 FormID가 있으면 스킵됩니다.
- WSL cross 환경의 `ctest`는 wine runtime 환경 상태에 따라 실행 제약이 있을 수 있습니다.

## 패키지
- 배포 파일: `releases/Codex of Power NG.zip`
- 태그: `v1.0.7`
- 릴리즈: https://github.com/servaltullius/CodexOfPowerNG/releases/tag/v1.0.7
